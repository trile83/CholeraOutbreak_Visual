<!DOCTYPE html>
<html lang = "en">
<head>
        <meta charset = "UTF-8">
        <title>John Snow 1854 Map of Cholera Death in London</title>
        <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
        
    <style type="text/css">
      /* No style rules here yet */   
      path {
        fill: white;
        stroke: black;
        stroke-width: 1px;
      }


      rect:hover {
        fill: orange;
      }

      circle:hover {
        fill: green;
      }

      h1, h2 {
    position: absolute;
    left: 10px;
    font-size: 1.3em;
    font-weight: 100;
      }
      
      h2 {
          top: 400px;
          left: 100px;
          font-size: 1em;
      }
     
      }
      .hover {
          fill: yellow;   
      }
      
    </style>
</head>
<body>
  





<script type="text/javascript">

        d3.csv("pumps.csv", display, function(error, csv) {
                text = container.selectAll("text")
                      .data(csv)
                      .enter()
                      .append("text")
                      .attr('class', 'text')
                      .text("Pump")
                      .attr("font-family", "sans-serif")
                      .attr("font-size", "9px")
                      .attr("fill", "black")           
                      .attr("x", function(d) { return d.x + 6; })
                      .attr("y", function(d) { return h-d.y; })
                    
                      ;
                        });



 //Width and height
      var w = 2000;
      var h = 1000;


      var zoom = d3.behavior.zoom()
          .scaleExtent([1, 10])
          .on("zoom", zoomed);


//Create SVG element
      var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            

            .call(zoom) 
            ; 


    //Draw Age Bar Chart

        var data1 = new Array;

        d3.csv("deaths_age_sex.csv", function(d) {
          return {
            age: d.age
          };
        },

 
      
       function(rows) {
             
            var counts = {};
            rows.forEach(function(r) {
                var key = r.age;
                if (!counts[key]) {
                    counts[key] = {
                       age: r.age,
                       count: 0
                    };
                }
                counts[key].count++;
            });

            
            Object.keys(counts).forEach(function(key) {
                data1.push(counts[key]);


                      });

                         drawBar();                       
                                  
                               });
//console.log(data);

console.log(data1);

                var Age_CHART_WIDTH = 180;
                var Age_CHART_HEIGHT = 200;
                var pushChart_vertical =100;
                var pushChart_horizontal = 800;

                svg.append("text")
                      .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
                      .attr("transform", "translate(900, 50)")  // text is drawn off the screen top left, move down and out and rotate
                      .text("Number of Deaths per Age Group Chart");
                

                function drawBar() 
                {
                  var maxValue = d3.max(data1);
                  var xScale = d3.scale.linear();
                  var yScale = d3.scale.linear();

                  xScale.domain([0, 180]).range([0, Age_CHART_WIDTH]);
                  yScale.domain([0, 5]).range([Age_CHART_HEIGHT, 0]);

                  
                  var g1 = d3.select('svg').select('g');



                  var xAxis = d3.svg.axis()
                      .scale(xScale)
                      .orient('bottom')
                      .tickFormat(function(d) { return "" + d; });

                    var yAxis = d3.svg.axis()
                      .scale(yScale)
                      .orient('left')
                      .ticks(6);


                    g1.append('g')
                      .attr('class', 'axis')
                      .attr('transform', 'translate('+pushChart_horizontal+',' + (Age_CHART_HEIGHT+pushChart_vertical) + ')')
                      .call(xAxis)
                      .selectAll("text")
                      .attr("y", 0)
                      .attr("x", 9)
                      .attr("dy", ".35em")
                      .attr("transform", "rotate(90)")
                      .style("text-anchor", "start");

                    g1.append('g')
                      .attr('class', 'axis')
                      .attr('transform', 'translate('+pushChart_horizontal+','+pushChart_vertical+')')
                      .call(yAxis);
                      

                    g1.selectAll('rect')
                      .data(data1)
                      .enter()
                      .append('rect')
                      .style('fill', 'steelblue')
                      .attr('width', function(d) {return d.count;})
                      .attr('height', 20)
                      .attr('x', pushChart_horizontal)
                      .attr('y', function(d) { return (yScale(d.age)-20 +pushChart_vertical) ;   }); 



                    function readAgeGroup(d) {
                            if (data1.age == 0) {return "0-10";}
                            else if (data1.age == 1) {return "11-20";}
                            else if (data1.age == 2) {return "21-40";}
                            else if (data1.age == 3) {return "41-60";}
                            else if (data1.age == 4) {return "61-80";}
                            else {return ">80";}
                          }
                }

    var CHART_WIDTH = 600;
    var CHART_HEIGHT = 160;

    var MAX_BAR_HEIGHT = 100;

    var deathdays = [];

    svg.append("text")
            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            .attr("transform", "translate(180, 80)")  // text is drawn off the screen top left, move down and out and rotate
            .text("Number of Deaths per Day Chart");


    function drawChart() {


  
      // define the x scale (horizontal)
        var mindate = new Date(2001,7,19),
            maxdate = new Date(2001,8,29);


      var maxValue = d3.max(deathdays);
      var xScale = d3.time.scale().domain([mindate, maxdate]).range([0, CHART_WIDTH] );     ;

      var yScale = d3.scale.linear();

      /*  xScale.domain([mindate, maxdate]).range([0, CHART_WIDTH]);*/
      
      yScale.domain([0,160]).range([CHART_HEIGHT+100, 100] );


      var g = d3.select('svg').select('g');

      var xAxis = d3.svg.axis()
          .scale(xScale)
          .orient('bottom')
          .ticks(d3.time.day, 2)
          ;

        var yAxis = d3.svg.axis()
          .scale(yScale)
          .orient('left');


        g.append('g')
          .attr('class', 'axis')
          .attr('transform', 'translate(100,' + (CHART_HEIGHT+100) + ')')
          .call(xAxis)
          .selectAll("text")
          .attr("y", 0)
          .attr("x", 9)
          .attr("dy", ".35em")
          .attr("transform", "rotate(90)")
          .style("text-anchor", "start");

        g.append('g')
          .attr('class', 'axis')
          .attr('transform', 'translate(100,0)')
          .call(yAxis);

        g.selectAll('rect')
          .data(deathdays)
          .enter()
          .append('rect')
          .attr('width', 10)
          .attr('height', function(d) {return d.death ; })
          .attr("fill", "blue")
          .attr("stroke", "blue")
          .attr("x", function(d) { return xScale(d.date)+100; })
          .attr("y", function(d) { return yScale(d.death); })
          .attr("class","incident")
          
            
          
            
            ;
    
        g.selectAll(".myLabel")//selection via class
          .data(deathdays)
          .enter()
          .append("text")
          .attr("class", "myLabel")//adding a class to the label
          .text(function(d) {
                 return d.death;
                   })
          .attr("x", function(d) { return xScale(d.date)+100; })
          .attr("y", function(d) { return yScale(d.death) - 10; })
          .attr("font-family", "sans-serif")
          .attr("font-size", "7px")
          .attr("fill", "black");


        // now add titles to the axes
        g.append("text")
            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            .attr("transform", "translate(40,"+(CHART_HEIGHT+200)/2+")rotate(90)")  // text is drawn off the screen top left, move down and out and rotate
            .text("Number of Deaths");



            function readDateof2Chart(d) {
                
                if (d.date == d.date) {return "red";}
                
                
            }

      };

      

      d3.csv('deathdays.csv', function(error, rows){
        rows.forEach(function(r) {
          deathdays.push({
            date: new Date(r.date),
            death: +r.deaths
          })
        });
        deathdays.forEach(function(b) {
          drawChart(b);
        });
      });

 
// Draw map
     


      var container = svg.append("g");
//Insert map label
       container.append("text")
            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            .attr("transform", "translate(150, 400)")  // text is drawn off the screen top left, move down and out and rotate
            .text("London Map 1854");

//Line function to read the coordinates 
      var lineFunction = d3.svg.line()
                          .x(function(d) { return d.x*30; })
                          .y(function(d) { return h-d.y*30; })
                          .interpolate("linear");




//Read CSV file to add pumps
      d3.csv("pumps.csv", display, function(error, csv) {
              dot = container.append("g")
                    .attr("class", "dot")
                    .selectAll("circle")
                    .data(csv)
                    .enter()
                    .append("circle")
                    .attr("r", 5)
                    .attr("fill", "black")
                    .attr("stroke", "black")
                    .attr("stroke-width", "2px")
                    .attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return h-d.y; })
                    ;
                     });


        var death_age_sex = [];
// Draw incident
    function drawIncident() {

        

      var shapes = svg.selectAll(".shapes")
            .data(death_age_sex).enter();




      shapes.append("circle")
          .filter(function(d){ return (d.gender == 1); })
          .attr("r", 3)
          .attr("fill", "lime")
          .attr("stroke", "black")
          .attr("stroke-width", "0.5px")
          .on("click", function(d) {
                  console.log(d);})
          .attr("cx", function(d) { return d.x*30; })
          .attr("cy", function(d) { return h-d.y*30; });


      shapes.append("rect")
          .filter(function(d){ return (d.gender ==0 ); })
          .attr("width", 2)
          .attr("height", 5)
          .attr("fill", "grey")
          .attr("stroke", "black")
          .attr("stroke-width", "0.5px")
          .on("click", function(d) {
                  console.log(d);})
          .attr("x", function(d) { return d.x*30; })
          .attr("y", function(d) { return h-d.y*30; });

      };

          d3.csv('deaths_age_sex.csv', function(error, rows){
                    
                    
                    var counter = 0;
                    for (i=0; i<deathdays.length; i++) 
                    {
                      var howManyPeopleDied = +deathdays[i].death;
                      for (j=0; j<howManyPeopleDied; j++) {
                        var r = rows[counter]
                         death_age_sex.push({
                            x: r.x,
                            y: r.y,
                            age: r.age,
                            gender: r.gender,
                            dateOfDeath: deathdays[i].date
                         });
                         counter++;
                        

                      }
                    }

                    rows.forEach(function(r) {
                      death_age_sex.push({
                        x: r.x,
                        y: r.y,
                        age: r.age,
                        gender: r.gender 
                      })
                    });
                    
                      drawIncident();
                    });
              
console.log(death_age_sex);

//Read JSON file to sketch map
      d3.json("streets.json", function(error,json) {
          path = container.append("g")
            .attr("class","path")  
            .selectAll("path")
            .data(json)
            .enter()
            .append("path")
            .attr("d", function(points){
              return lineFunction(points)
            });
        });


      function display(d) {
        d.x = d.x*30;
        d.y = d.y*30;
        return d;
      }

      function zoomed() {
        svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");    
      }

      function readDateof2Chart(d) {
                
                if (d.date == d.date) {return "red";}
                
                
            }

//Draw Gender Bar Chart

        var data2 = new Array;

        d3.csv("deaths_age_sex.csv", function(d) {
          return {
            gender: d.gender
          };
        },

  
       function(rows) {
             
            var counts = {};
            rows.forEach(function(r) {
                var key = r.gender;
                if (!counts[key]) {
                    counts[key] = {
                       gender: r.gender,
                       count: 0
                    };
                }
                counts[key].count++;
            });

            
            Object.keys(counts).forEach(function(key) {
                data2.push(counts[key]);


                      });

                         console.log(data2);                       
                                  
                               });

      

</script>
</svg>
</body>
</html>

